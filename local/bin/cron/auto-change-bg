#!/usr/bin/env sh
# change wallpaper
# dependence: sway fortune convert wl-copy
# help: http://www.imagemagick.org/Usage/ 
# https://blog.csdn.net/yuxiangji/article/details/24964577

WP_DIR="$HOME/.config/variety/Downloaded/"
WP_DIR2="$HOME/.wallpaper/"
LOG="/tmp/autochagebg.log"
RESULT="/tmp/wallpaper.jpg"
WPTEXT="/tmp/wallpaper.txt"

change_bg(){
  # todo: get the display width
  # display_w="$(swaymsg -t get_outputs -p | grep 'Current mode:' | awk '{print $3}' | cut -dx -f1)"
  num=$(echo $RANDOM % $TOTAL + 1 | bc)
  # echo $num
  # echo $LOG
  wallpaper="$(sed -n "${num}p" ${LOG} 2> /dev/null)"
  # file "${wallpaper}"
  fortune -s > $WPTEXT 2>/dev/null
  time_var=$(date +%H:%M)
  month_var=$(date "+%B %d")
  weekday_var=$(date "+%A")
  height=$(identify "$wallpaper" | sed -e 's/.*\( [0-9]*x[0-9]* \).*/\1/' | cut -d"x" -f2)
  quote_h=$((height/2))
  echo "$wallpaper" | wl-copy -p
  convert "${wallpaper}" \
    -font Cantarell \
    -fill white \
    -weight bolder \
    -pointsize 48 \
    -gravity southeast \
    -annotate +50+$quote_h \
    @"${WPTEXT}" \
    -draw "text 100,$((quote_h-48)) '${time_var}'" \
    -draw "text 100,$((quote_h-96)) '${month_var}'" \
    -draw "text 100,$((quote_h-144)) '${weekday_var}'" \
    "${RESULT}" 2>/dev/null
  sleep 1
  file "$RESULT" | grep -iE 'jpeg|jpg|png' >/dev/null 2>&1
  if [ "$?" -eq "0" ]; then
    kill $(pgrep -x swaybg) >/dev/null 2>&1
    swaybg -o "*" -i "$RESULT" -m fill & >/dev/null
  fi
}

[[ -f ${LOG} && $(wc -l ${LOG} | awk '{print $1}') -gt 0 ]] || find "$WP_DIR" "$WP_DIR2" -type f -name '*.jpg' -o -name '*.png' > ${LOG}
TOTAL=$(cat ${LOG} | wc -l)
# echo $TOTAL

if [ "${1}" == "onece" ]; then
  change_bg
else
  while :
  do
    echo "do change bg ...."
    change_bg
    sleep 60
  done
fi
